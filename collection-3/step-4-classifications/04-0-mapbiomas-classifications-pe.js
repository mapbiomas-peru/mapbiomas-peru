/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var geometry_11 = 
    /* color: #d63000 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-70.30947571356651, 2.294272817961065],
                  [-70.32870178778526, 2.2949589128903582],
                  [-70.3307617243087, 2.279178646414297],
                  [-70.31153565008995, 2.2771203380086624]]]),
            {
              "id": 11,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-70.10691528876183, 2.128914570681864],
                  [-70.13026123602745, 2.1296007420964234],
                  [-70.12545471747276, 2.1069569246605337],
                  [-70.1110351618087, 2.109015467176341]]]),
            {
              "id": 11,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-77.51789436162298, -9.908292525168555]),
            {
              "id": 11,
              "system:index": "2"
            })]),
    geometry_13 = 
    /* color: #98ff00 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-70.44405823309776, 2.2414425274252405],
                  [-70.4571044977462, 2.2325229383674814],
                  [-70.44886475165245, 2.2215449083140015],
                  [-70.42551880438683, 2.224289423492906]]]),
            {
              "id": 13,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-70.42757874091026, 2.277806441137374],
                  [-70.41933899481651, 2.2599676538690887],
                  [-70.39873962958214, 2.26065376513581],
                  [-70.39805298407433, 2.2750620266627446]]]),
            {
              "id": 13,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-78.95804197824856, -7.276236149200641],
                  [-78.96092266825725, -7.277624979448226],
                  [-78.96201969579619, -7.2802775912314335],
                  [-78.9601984745478, -7.281823391522298],
                  [-78.95801515561199, -7.280743202339095],
                  [-78.95600349939723, -7.281536051704467],
                  [-78.95505936182398, -7.281536051704467],
                  [-78.95493061579127, -7.282451289570448],
                  [-78.95289213693995, -7.28249385872805],
                  [-78.95287067926783, -7.281323205421386],
                  [-78.95121843851466, -7.281195497603032],
                  [-78.95113260782618, -7.281812751721435],
                  [-78.94948036707301, -7.281897890153836],
                  [-78.94948036707301, -7.281259351516757],
                  [-78.94905121363063, -7.281089074393299],
                  [-78.94926579035182, -7.278747757389875],
                  [-78.94954474008937, -7.278300777299933]]]),
            {
              "id": 13,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-78.94317494378902, -7.280065064334423],
                  [-78.9432607744775, -7.2824915127803305],
                  [-78.9425955866418, -7.282683073940521],
                  [-78.94238100992061, -7.283704732079143],
                  [-78.94132958398677, -7.283704732079143],
                  [-78.9412437532983, -7.28215095940457],
                  [-78.94072876916744, -7.282108390214411],
                  [-78.94094334588863, -7.2807036046720555]]]),
            {
              "id": 13,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-78.96594459987125, -7.272891877752014],
                  [-78.96500046229801, -7.274211547878599],
                  [-78.96272594905338, -7.274637247091818],
                  [-78.95985062098941, -7.268124004974902],
                  [-78.95774776912174, -7.2641223584072625],
                  [-78.95691629772102, -7.258912696521581],
                  [-78.96003302017021, -7.257108736605571],
                  [-78.96283323796168, -7.257417394991912],
                  [-78.96397049403629, -7.264335212845338],
                  [-78.96461422419986, -7.269358548318033],
                  [-78.96628792262516, -7.271189071856872]]]),
            {
              "id": 13,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-78.96444965086994, -7.2867255780347655],
                  [-78.96470714293537, -7.288428324946379],
                  [-78.96444965086994, -7.291067569868569],
                  [-78.96290469847736, -7.296558852188975],
                  [-78.96226096831379, -7.296899394610434],
                  [-78.96045852385578, -7.294558160229436],
                  [-78.95985770903644, -7.292812868450829],
                  [-78.96011520110187, -7.291748662807604],
                  [-78.9580123492342, -7.2911952748735445],
                  [-78.95796943388996, -7.289662812410372],
                  [-78.95874191008625, -7.289577675453112],
                  [-78.96114516936359, -7.2903439074858225],
                  [-78.96243262969074, -7.290471612697152],
                  [-78.96260429106769, -7.289577675453112],
                  [-78.9623897143465, -7.289237127462272],
                  [-78.96144557677326, -7.289237127462272],
                  [-78.95994353972492, -7.289237127462272],
                  [-78.95934272490558, -7.288726304990557],
                  [-78.96105933867511, -7.286087046274644],
                  [-78.96333385191974, -7.286087046274644]]]),
            {
              "id": 13,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-78.95012845925099, -7.291960783771896],
                  [-78.94776811531788, -7.291407396099978],
                  [-78.94742479256398, -7.286299169919964],
                  [-78.9478968613506, -7.2848092596467575],
                  [-78.94866933754689, -7.284766690709021],
                  [-78.94871225289113, -7.287363388510858],
                  [-78.9502572052837, -7.288470173163937],
                  [-78.95034303597218, -7.289704660512602]]]),
            {
              "id": 13,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-78.96082353047021, -7.283882521619566],
                  [-78.96082353047021, -7.284989314869825],
                  [-78.95914983204491, -7.285457572729866],
                  [-78.95773362568505, -7.286521793319497],
                  [-78.95674657276757, -7.286947480847675],
                  [-78.95558785847314, -7.287245461876768],
                  [-78.95537328175195, -7.286096105386929],
                  [-78.95494412830956, -7.286138674198372],
                  [-78.95455789021142, -7.2868197746316845],
                  [-78.9531845991958, -7.2873731679714275],
                  [-78.95211171558984, -7.284733901285427],
                  [-78.95640325001366, -7.284478487555461]]]),
            {
              "id": 13,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-79.01253352982361, -7.255661178253932],
                  [-79.0118468843158, -7.2618766033114985],
                  [-79.00858531815369, -7.265111996056333],
                  [-79.0048945985492, -7.265111996056333],
                  [-79.00292049271424, -7.265963411329086],
                  [-79.00223384720643, -7.267581095903006],
                  [-79.00094638687928, -7.2713272904461785],
                  [-79.00043140274842, -7.274136915844918],
                  [-79.00223384720643, -7.276605966071568],
                  [-79.00249133927186, -7.277797916491217],
                  [-79.00043140274842, -7.278479029594956],
                  [-78.99674068314393, -7.276009989674359],
                  [-78.99519573075135, -7.2760939754889975],
                  [-78.99485240799744, -7.277371066560414],
                  [-78.99802814347107, -7.279073849000948],
                  [-78.99742732865174, -7.2807766249776025],
                  [-78.99459491593201, -7.281287456509929],
                  [-78.99322162491639, -7.281372595042073],
                  [-78.99090419632752, -7.277626484338513],
                  [-78.98904244198667, -7.275458537492492],
                  [-78.98698250546323, -7.2716272370503425],
                  [-78.98372093930112, -7.268687310146732],
                  [-78.9856092144476, -7.267580476687405],
                  [-78.98887078060972, -7.268857591975349],
                  [-78.99058739437925, -7.268687310146732],
                  [-78.99127403988706, -7.266047933549946],
                  [-78.99230400814878, -7.265111376837335],
                  [-78.99470726742612, -7.266133074972476],
                  [-78.9973680187689, -7.265366801588889],
                  [-78.99865547909604, -7.263663967170089],
                  [-79.0017453838812, -7.261790841859146],
                  [-79.00277535214292, -7.260087993896042],
                  [-79.00363365902768, -7.2583851394855605],
                  [-79.00569359555112, -7.256937708168496],
                  [-79.00809685482847, -7.257193137562821]]]),
            {
              "id": 13,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-79.01121541893268, -7.270899427643539],
                  [-79.01263162529254, -7.272729944901304],
                  [-79.0120308104732, -7.279370828564094],
                  [-79.01130124962116, -7.2818824192016915],
                  [-79.007310122607, -7.282989217390027],
                  [-79.00349065696979, -7.282861510046199],
                  [-79.00336191093707, -7.280605340974194],
                  [-79.00546476280475, -7.278008604030529],
                  [-79.00662347709918, -7.277497768764015],
                  [-79.00752469932819, -7.275284142555294],
                  [-79.00791093742633, -7.2729427952608905],
                  [-79.00743886863971, -7.270473724886215],
                  [-79.00894090568805, -7.267366082534438],
                  [-79.01018545067096, -7.267621506004368],
                  [-79.01125833427692, -7.269835169993641]]]),
            {
              "id": 13,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-79.05709443563907, -7.420473770199416],
                  [-79.05559239859073, -7.4209418851967275],
                  [-79.05494866842716, -7.423112230038616],
                  [-79.05323205465763, -7.424176120656958],
                  [-79.05250249380558, -7.424091009502216],
                  [-79.0515154408881, -7.42238878294796],
                  [-79.05027089590519, -7.421154664576296],
                  [-79.05031381124942, -7.419963098725158],
                  [-79.04829679007022, -7.419580094730458],
                  [-79.0483826207587, -7.418899197916662],
                  [-79.04735265249698, -7.417835294535799],
                  [-79.04572186941593, -7.418601305229296],
                  [-79.04610810751407, -7.414686125455761],
                  [-79.04404817099064, -7.414047777625895],
                  [-79.04529148281284, -7.411049345516641],
                  [-79.04572063625523, -7.409644967472701],
                  [-79.04739433468052, -7.407346884654032],
                  [-79.04842430294224, -7.407261770245416],
                  [-79.049282609827, -7.404282755588939],
                  [-79.04996925533482, -7.404282755588939],
                  [-79.04945427120396, -7.407176655820351],
                  [-79.04915386379429, -7.411347243314016],
                  [-79.05035549343296, -7.4127630684816355],
                  [-79.05258709133335, -7.411231025444963],
                  [-79.05246480298986, -7.413663161497501],
                  [-79.05276521039953, -7.415578203883382],
                  [-79.05727132154455, -7.418812478773407]]]),
            {
              "id": 13,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-79.01394750755212, -7.39531340279799],
                  [-79.01613619010827, -7.396675268258],
                  [-79.01652242820641, -7.399526660453915],
                  [-79.01677992027184, -7.402803610814421],
                  [-79.01647951286218, -7.40612309414453],
                  [-79.01223089378259, -7.408548854615978],
                  [-79.00858308952233, -7.410123463915018],
                  [-79.00463487785241, -7.409016982292698],
                  [-79.00477551074667, -7.407663345490659],
                  [-79.00662087054891, -7.404684333548161],
                  [-79.0055909022872, -7.404726891003371],
                  [-79.00421761127157, -7.404769448454482],
                  [-79.00323055835409, -7.406429185842964],
                  [-79.00237225146932, -7.406131284720588],
                  [-79.00232933612509, -7.404684333548161],
                  [-79.00250099750204, -7.401832974691875],
                  [-79.00353096576376, -7.397747413456494],
                  [-79.00520466418905, -7.397066482905907],
                  [-79.00910996051473, -7.396938808310698],
                  [-79.01026867480917, -7.395789735291879],
                  [-79.01215694995565, -7.394896009764742],
                  [-79.01361607165975, -7.39523647684558]]]),
            {
              "id": 13,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-78.61576534931652, -7.609322825334273],
                  [-78.6202285451173, -7.614512360636646],
                  [-78.61533619587414, -7.61744739786793],
                  [-78.61143089954845, -7.6190637865980735],
                  [-78.60907055561535, -7.62012719690981],
                  [-78.60829807941906, -7.621062995799914],
                  [-78.60563732807628, -7.621360749563349],
                  [-78.60246159260265, -7.618510812192571],
                  [-78.60121704761974, -7.615192950770456],
                  [-78.6008308095216, -7.613619084445896],
                  [-78.60250450794689, -7.6117049149116225],
                  [-78.60452152912609, -7.60996088634],
                  [-78.60537983601085, -7.607834012629469],
                  [-78.60580898945324, -7.606642958745146],
                  [-78.60713936512462, -7.606770571819483],
                  [-78.60816933338634, -7.603981190811553],
                  [-78.61018635456554, -7.603598348986072],
                  [-78.61190296833507, -7.603853576907675],
                  [-78.61293293659679, -7.6042364185054945],
                  [-78.61409165089123, -7.604917024947241],
                  [-78.61550785725109, -7.607214063718253],
                  [-78.61559368793957, -7.608873028515143]]]),
            {
              "id": 13,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-79.09390645783436, -7.378847243236756],
                  [-79.09493642609608, -7.383613931617872],
                  [-79.07708364289296, -7.416979309590979],
                  [-79.06403737824452, -7.410170253826311],
                  [-79.06901555817616, -7.39859461754367],
                  [-79.07553869050038, -7.393657856727878],
                  [-79.06111913483632, -7.403072198804777],
                  [-79.0600891665746, -7.397624790719231],
                  [-79.05940252106679, -7.380260728905855],
                  [-79.06386571686757, -7.3743023152440355],
                  [-79.0824051455785, -7.371918927320997]]]),
            {
              "id": 13,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-78.95204432589796, -7.432551057198033],
                  [-78.950070220063, -7.434210689789706],
                  [-78.94779570681837, -7.434168135186208],
                  [-78.9463795004585, -7.433529815639056],
                  [-78.94294627291944, -7.433997916731033],
                  [-78.94045718295362, -7.433444706295995],
                  [-78.93844016177442, -7.430210539038817],
                  [-78.93904097659376, -7.4283806707019515],
                  [-78.94041426760938, -7.426338017977024],
                  [-78.94277461154249, -7.425061355203579],
                  [-78.94663699252393, -7.424806022204004],
                  [-78.94886859042433, -7.425444354424904],
                  [-78.95144351107862, -7.426721016086057],
                  [-78.95723708255079, -7.4283806707019515]]]),
            {
              "id": 13,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-78.85307473195024, -7.51963897868508],
                  [-78.84929818165728, -7.520149533684755],
                  [-78.83891266835161, -7.516065076874481],
                  [-78.83745354664751, -7.508066237691734],
                  [-78.84062928212114, -7.502535039408995],
                  [-78.8451783086104, -7.4996417692143345],
                  [-78.85144394886919, -7.497514352388293],
                  [-78.8561646367354, -7.497599449260958],
                  [-78.85805291188188, -7.502535039408995],
                  [-78.85942620289751, -7.50730038366427],
                  [-78.85865372670122, -7.511980581647571],
                  [-78.85444802296587, -7.516745822344557]]]),
            {
              "id": 13,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-78.71825603792902, -7.609192797855483],
                  [-78.71259121248957, -7.602727057504204],
                  [-78.71241955111262, -7.592858108171684],
                  [-78.71705440829035, -7.5894549696388],
                  [-78.73061565706965, -7.592007326064038],
                  [-78.73164562533137, -7.598473227838147],
                  [-78.72392086336848, -7.610724143138596]]]),
            {
              "id": 13,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-79.02562091872977, -7.607118836061851],
                  [-79.02012775466727, -7.608735263738841],
                  [-79.01875446365165, -7.60779943793141],
                  [-79.01995609329032, -7.602950126053801],
                  [-79.00974224136161, -7.602694897594986],
                  [-79.00879810378837, -7.600142604661179],
                  [-79.01034305618094, -7.588231703797072],
                  [-79.01798198745536, -7.580914843963543],
                  [-79.01815364883231, -7.583041850927356],
                  [-79.0255350880413, -7.582871690757054],
                  [-79.03042743728446, -7.586530119590604],
                  [-79.03016994521903, -7.589252651089649],
                  [-79.0299835092123, -7.595007287074691],
                  [-79.02912520232753, -7.597729764884319],
                  [-79.03036974731044, -7.599090997318797]]]),
            {
              "id": 13,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-78.94420493417383, -7.323067172592322],
                  [-78.94326079660058, -7.324429259875563],
                  [-78.94094336801172, -7.325535952728546],
                  [-78.93918383889795, -7.324684650777835],
                  [-78.9387976007998, -7.323620521053051],
                  [-78.93931258493066, -7.322386127390155],
                  [-78.93896926217676, -7.320726075352019],
                  [-78.93785346322656, -7.316299239711739],
                  [-78.93802512460351, -7.3153627880826955],
                  [-78.94004214578271, -7.3155330521614],
                  [-78.94158709817529, -7.31634180564819],
                  [-78.94278872781396, -7.318001874002546],
                  [-78.9428316431582, -7.3187680573136245],
                  [-78.9439474421084, -7.3198747642175475],
                  [-78.94437659555078, -7.3220881697870945]]]),
            {
              "id": 13,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-78.93449715985189, -7.323699395638559],
                  [-78.9308064402474, -7.326551257077075],
                  [-78.9305918635262, -7.32540200167754],
                  [-78.93286637677083, -7.317442262596953],
                  [-78.93488339795003, -7.318123315348255],
                  [-78.93634251965413, -7.321060343427842]]]),
            {
              "id": 13,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.58956412841333, -13.764327431744146],
                  [-75.58600215484155, -13.766411568822322],
                  [-75.58304099608911, -13.765911377617384],
                  [-75.58445720244897, -13.764785943494827],
                  [-75.58750419188989, -13.763993968088185]]]),
            {
              "id": 13,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.60247775598357, -13.771075716878563],
                  [-75.60282107873748, -13.773576606962719],
                  [-75.60080405755828, -13.77570234249532],
                  [-75.5989157824118, -13.77524385215309],
                  [-75.59827205224822, -13.771867668300095],
                  [-75.59677001519988, -13.771575897035884],
                  [-75.59681293054412, -13.768283024666397],
                  [-75.59805747552703, -13.76778283746444],
                  [-75.60106154962371, -13.769033303463136],
                  [-75.60260650201629, -13.769074985547919]]]),
            {
              "id": 13,
              "system:index": "21"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.58643341265929, -13.75392884273452],
                  [-75.58887958728087, -13.756680022029169],
                  [-75.58862209521544, -13.75726360135834],
                  [-75.58360099993956, -13.7550960136575],
                  [-75.58471679888976, -13.754053897040354]]]),
            {
              "id": 13,
              "system:index": "22"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.57253129722461, -13.764022020763205],
                  [-75.57257421256885, -13.766356256090836],
                  [-75.56978471519336, -13.765189141339123],
                  [-75.56922681571827, -13.764813996074864],
                  [-75.56969888450489, -13.761979545742241],
                  [-75.56957013847217, -13.759853685454482],
                  [-75.56995637657032, -13.757852858127267],
                  [-75.56987054588184, -13.757477701098772],
                  [-75.57098634483204, -13.756894122303502],
                  [-75.5749774718462, -13.754393053841614],
                  [-75.57566411735401, -13.755560222449798],
                  [-75.57338960410938, -13.759270112584712],
                  [-75.57223088981495, -13.761646078739227],
                  [-75.57197339774952, -13.763063310219161]]]),
            {
              "id": 13,
              "system:index": "23"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.56294399832315, -13.74914896359684],
                  [-75.56466061209268, -13.75294232527145],
                  [-75.56363064383096, -13.754401294164637],
                  [-75.56436020468301, -13.755860253964086],
                  [-75.56487518881387, -13.757069099479745],
                  [-75.56470352743692, -13.759153301221817],
                  [-75.56350189779825, -13.763029867082057],
                  [-75.56152779196329, -13.76436372435135],
                  [-75.56032616232461, -13.764582716285604],
                  [-75.56036907766885, -13.766291708194965],
                  [-75.5601974162919, -13.767920544184399],
                  [-75.55800873373575, -13.768045591011562],
                  [-75.55805164907999, -13.763418813874555],
                  [-75.56006867025918, -13.759959091887076],
                  [-75.55997819356503, -13.755902199264755],
                  [-75.56126565389218, -13.751650348960174],
                  [-75.56203813008847, -13.749566080409497]]]),
            {
              "id": 13,
              "system:index": "24"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.555880353092, -13.769494338862623],
                  [-75.56047229492549, -13.773245689332395],
                  [-75.56163100921992, -13.775454789776596],
                  [-75.5611589404333, -13.77720538284525],
                  [-75.56175975525264, -13.780456449462394],
                  [-75.56180267059688, -13.781039969451063],
                  [-75.55991439545039, -13.781248369093772],
                  [-75.55884151184443, -13.782457083355064],
                  [-75.55721072876338, -13.78399922695211],
                  [-75.55579452240352, -13.782873879925928],
                  [-75.55519370758418, -13.780789889634399],
                  [-75.55390624725703, -13.779872928016186],
                  [-75.54974345886592, -13.77966452714647],
                  [-75.54892806732539, -13.77720538284525],
                  [-75.55197505676631, -13.776121683920513],
                  [-75.55313377106074, -13.773120645286625],
                  [-75.55253295624141, -13.770536386698089],
                  [-75.55236129486445, -13.76791041725795],
                  [-75.55463580810908, -13.76757695871085],
                  [-75.55639533722285, -13.768077146353198],
                  [-75.556781575321, -13.76866069725031]]]),
            {
              "id": 13,
              "system:index": "25"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.53376455271243, -13.765813234013411],
                  [-75.53629655802249, -13.766230060266752],
                  [-75.5384423252344, -13.768314180389035],
                  [-75.5387856479883, -13.76968968949399],
                  [-75.53852815592288, -13.771065190506532],
                  [-75.53775567972659, -13.774524748184177],
                  [-75.53711194956301, -13.777609129920945],
                  [-75.53170461618899, -13.777234004586983],
                  [-75.52904386484622, -13.77669215581921],
                  [-75.52844305002688, -13.771815460374969],
                  [-75.52741308176516, -13.7690644590858],
                  [-75.53046007120608, -13.766146695075518]]]),
            {
              "id": 13,
              "system:index": "26"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.52688627443115, -13.745097761978716],
                  [-75.52808790406982, -13.747598929737622],
                  [-75.52345304689209, -13.753018034904677],
                  [-75.51993398866455, -13.75977089808272],
                  [-75.51589994630615, -13.759187325006456],
                  [-75.51452665529052, -13.755935962653528],
                  [-75.51667242250244, -13.751767483306313],
                  [-75.51924734315674, -13.748849503600251],
                  [-75.5215647717456, -13.745764742659368],
                  [-75.52225141725341, -13.747182070299367],
                  [-75.52216558656494, -13.748599389361994],
                  [-75.52362470826904, -13.74793241675397]]]),
            {
              "id": 13,
              "system:index": "27"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.56658747057554, -13.794044514712057],
                  [-75.56791784624693, -13.795253162728427],
                  [-75.56933405260679, -13.797712116954395],
                  [-75.56989195208189, -13.79979595618047],
                  [-75.56753160814878, -13.798754038894154],
                  [-75.56366922716734, -13.798837392448313],
                  [-75.56178095202085, -13.797795470880818],
                  [-75.56113722185728, -13.79692025316815],
                  [-75.56083681444761, -13.797045284470975],
                  [-75.55954935412046, -13.798295593813942],
                  [-75.55916311602232, -13.797753793921334],
                  [-75.55890562395689, -13.796086709437125],
                  [-75.55886270861265, -13.794961420676936],
                  [-75.55843355517027, -13.794753033273992],
                  [-75.55787565569517, -13.794502968144812],
                  [-75.55637361864683, -13.794044514712057],
                  [-75.5561161265814, -13.792669149010107],
                  [-75.55821897844908, -13.79150216569497],
                  [-75.5590343699896, -13.790460211376159],
                  [-75.56045057634947, -13.789751679782778],
                  [-75.56087972979185, -13.790251819954282],
                  [-75.5607080684149, -13.792544115362578],
                  [-75.56238176684019, -13.793210960708745],
                  [-75.56487085680601, -13.792919216104236]]]),
            {
              "id": 13,
              "system:index": "28"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.50808000812093, -13.863126727965824],
                  [-75.50829458484212, -13.864335017306333],
                  [-75.50730753192464, -13.865543300357755],
                  [-75.50623464831868, -13.867376545390316],
                  [-75.50567674884358, -13.86995972972141],
                  [-75.50340223559895, -13.872501221724526],
                  [-75.50172853717366, -13.870251377758692],
                  [-75.50129938373128, -13.867959847591306],
                  [-75.50202894458333, -13.86520998152349],
                  [-75.50404596576253, -13.863710040846417],
                  [-75.50499010333577, -13.862418417497658],
                  [-75.50623464831868, -13.862376752108712],
                  [-75.50777960071126, -13.862460082879133]]]),
            {
              "id": 13,
              "system:index": "29"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.53487164637119, -13.897467321919482],
                  [-75.53216797968417, -13.897717276310427],
                  [-75.53070885798007, -13.896592479426545],
                  [-75.53122384211093, -13.895592655387794],
                  [-75.53401333948642, -13.894592827032703],
                  [-75.53727490564853, -13.89571763362869]]]),
            {
              "id": 13,
              "system:index": "30"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.55043859578784, -13.905240875295984],
                  [-75.54936571218188, -13.906199000154507],
                  [-75.54730577565844, -13.906990491610799],
                  [-75.54365797139819, -13.90707380634345],
                  [-75.53898019887622, -13.906323972669693],
                  [-75.5390660295647, -13.905657451808839],
                  [-75.54005308248217, -13.90436606217828],
                  [-75.54168386556323, -13.90049185005574],
                  [-75.54039640523608, -13.897825687923115],
                  [-75.54121179677661, -13.897159142593123],
                  [-75.54340047933276, -13.89895047881674],
                  [-75.54975195028003, -13.903616219731317]]]),
            {
              "id": 13,
              "system:index": "31"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.56229891845001, -13.895200148031185],
                  [-75.55633368560089, -13.898366248044821],
                  [-75.55337252684845, -13.89603333644199],
                  [-75.5546599871756, -13.893325463147976],
                  [-75.55843653746857, -13.891700723976424],
                  [-75.56058230468048, -13.891909024507031],
                  [-75.56229891845001, -13.89399201951148]]]),
            {
              "id": 13,
              "system:index": "32"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.51346369900081, -13.909878717594726],
                  [-75.50745555080745, -13.9093580063359],
                  [-75.50756283916805, -13.908545694432027],
                  [-75.51140376247737, -13.905213102926517],
                  [-75.5147940746722, -13.906712775043355],
                  [-75.51470824398372, -13.909066407519061]]]),
            {
              "id": 13,
              "system:index": "33"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.53575153190042, -13.965396715194993],
                  [-75.5336057646885, -13.964480482943197],
                  [-75.52751178580667, -13.963397658311926],
                  [-75.52442188102151, -13.961898354268305],
                  [-75.5182420714512, -13.961065403362483],
                  [-75.51154727775003, -13.959649379913728],
                  [-75.50974483329202, -13.954484985387891],
                  [-75.50931567984964, -13.948404179044985],
                  [-75.51008815604592, -13.94773777956192],
                  [-75.51334972220803, -13.949487074099093],
                  [-75.5266534789219, -13.948654078354828],
                  [-75.53085918265725, -13.950403365943375],
                  [-75.53334827262307, -13.955734446285089],
                  [-75.53540820914651, -13.958399940234534],
                  [-75.53532237845803, -13.963231069455476]]]),
            {
              "id": 13,
              "system:index": "34"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.50088343689028, -13.95991004798766],
                  [-75.49702105590883, -13.95916038584064],
                  [-75.49616274902407, -13.957577757745877],
                  [-75.49813685485903, -13.95407927814104],
                  [-75.50217089721743, -13.954245873611645],
                  [-75.50260005065981, -13.957244571499306]]]),
            {
              "id": 13,
              "system:index": "35"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.51350535247246, -13.970638933974616],
                  [-75.52140177581231, -13.972054889879901],
                  [-75.52131594512383, -13.977968493949101],
                  [-75.51711024138848, -13.98005071274059],
                  [-75.50792635772149, -13.97730217995749],
                  [-75.50629557464043, -13.972304763547656],
                  [-75.51058710906426, -13.970389058499364]]]),
            {
              "id": 13,
              "system:index": "36"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.35192650314276, -14.108545249810966],
                  [-75.35192650314276, -14.110210076998625],
                  [-75.35055321212714, -14.112665674904457],
                  [-75.34956615920966, -14.114580190508386],
                  [-75.34840744491522, -14.11570392043636],
                  [-75.34398716445868, -14.115787159469813],
                  [-75.33900898452704, -14.114746669365951],
                  [-75.33528319907867, -14.112639279999332],
                  [-75.33180705619537, -14.109642614244189],
                  [-75.33154956412994, -14.107811299110146],
                  [-75.3372143895694, -14.106354560657262],
                  [-75.34021846366608, -14.103149703299463],
                  [-75.34245006156647, -14.099320464025851],
                  [-75.34382335258209, -14.099611821447546],
                  [-75.34591643574447, -14.101974815144953],
                  [-75.34720389607162, -14.103265094457026],
                  [-75.35162417652816, -14.10646995019301],
                  [-75.35128085377426, -14.108384517839617]]]),
            {
              "id": 13,
              "system:index": "37"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.16047038361516, -14.212727914775325],
                  [-75.16055621430364, -14.215057600290006],
                  [-75.15901126191106, -14.216721646680842],
                  [-75.15712298676458, -14.218884888683894],
                  [-75.15523471161809, -14.220382505639789],
                  [-75.15283145234075, -14.219966501924835],
                  [-75.15274562165227, -14.217387261808916],
                  [-75.14991320893255, -14.213476744878845],
                  [-75.14999903962102, -14.2107310223811],
                  [-75.15111483857122, -14.208234882103962],
                  [-75.15111483857122, -14.206321155911263],
                  [-75.15068568512883, -14.205322683647655],
                  [-75.14931239411321, -14.204823445864093],
                  [-75.14699496552434, -14.204906652237828],
                  [-75.14287509247747, -14.20590512633673],
                  [-75.1420167855927, -14.207402829226025],
                  [-75.13746775910344, -14.209649364975183],
                  [-75.13480700776067, -14.209649364975183],
                  [-75.13300456330266, -14.204573826559406],
                  [-75.1339487008759, -14.200163840123956],
                  [-75.13789691254583, -14.19600339682486],
                  [-75.144591706247, -14.194339198105634],
                  [-75.14982737824407, -14.19533771880442],
                  [-75.15326060578313, -14.199414965971053],
                  [-75.15454806611028, -14.202909690826814],
                  [-75.1566938333222, -14.206321155911263],
                  [-75.1599553994843, -14.211979082193022]]]),
            {
              "id": 13,
              "system:index": "38"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-74.99989845742088, -14.49355768832367],
                  [-74.99998428810936, -14.495385863059656],
                  [-74.99346115578514, -14.495552060015141],
                  [-74.99071457375389, -14.494388678709429],
                  [-74.9884829758535, -14.493183741633642],
                  [-74.9893139930184, -14.490721004670075],
                  [-74.98789778665854, -14.488643488492253],
                  [-74.98605242685629, -14.48635819821371],
                  [-74.98558035806967, -14.485942688360044],
                  [-74.98412123636557, -14.487895577902878],
                  [-74.98137465433432, -14.482826339644252],
                  [-74.98098841623617, -14.481995305925382],
                  [-74.98184672312094, -14.480000812298428],
                  [-74.9856232734139, -14.479917708008182],
                  [-74.99064436868979, -14.48187065059903],
                  [-74.99017229990316, -14.482743236412471],
                  [-74.98903384977297, -14.484175607222731],
                  [-74.98920551114992, -14.48533904212116],
                  [-74.99634840139464, -14.485796104161455],
                  [-75.00141241201476, -14.491239225135171]]]),
            {
              "id": 13,
              "system:index": "39"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.00040581353346, -14.501773278801052],
                  [-74.99800255425612, -14.49977896310337],
                  [-74.9989896071736, -14.4983663119556],
                  [-75.00040581353346, -14.497244494334016],
                  [-75.00268032677809, -14.496745906901396],
                  [-75.00328114159743, -14.497867727047195],
                  [-75.00340988763014, -14.501399345975305],
                  [-75.00070622094313, -14.501897922936038]]]),
            {
              "id": 13,
              "system:index": "40"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-74.83716973793769, -14.525656040047469],
                  [-74.83725556862616, -14.527567036175997],
                  [-74.8361826850202, -14.528813329100887],
                  [-74.83476647866034, -14.529644187147824],
                  [-74.83339318764472, -14.529644187147824],
                  [-74.83244905007147, -14.52897950096008],
                  [-74.82862958443427, -14.527650122589552],
                  [-74.82755670082831, -14.525905301348654],
                  [-74.82790002358222, -14.524783623280827],
                  [-74.83107575905585, -14.52453436071536],
                  [-74.83605393898749, -14.524825167014422]]]),
            {
              "id": 13,
              "system:index": "41"
            })]),
    complementarias = ee.FeatureCollection("projects/mapbiomas-raisg/MAPBIOMAS-PERU/COLECCION2/MUESTRAS/GEOMETRIAS_COMPLEMENTARIAS/ESTABLES/polygons-1985-2022-70401-PERU-1"),
    geometry_21 = 
    /* color: #81d626 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-79.52777321715466, -5.071791998137953],
                  [-79.52605660338513, -5.07132177746659],
                  [-79.52592785735241, -5.069184406462861],
                  [-79.52685053725354, -5.068564567548685],
                  [-79.52800925154797, -5.067923354252988],
                  [-79.52976878066174, -5.066897411656213],
                  [-79.53043396849743, -5.067346261742747],
                  [-79.53135664839856, -5.068414951169944],
                  [-79.52880318541638, -5.070808809070891]]]),
            {
              "id": 21,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-79.53321589662923, -5.106888533240103],
                  [-79.53167094423665, -5.106952650716243],
                  [-79.53164948656453, -5.106354220689604],
                  [-79.52978266909017, -5.106503828248629],
                  [-79.52967538072957, -5.108555585535434],
                  [-79.52727212145223, -5.108662447714179],
                  [-79.52737940981282, -5.107294610480678],
                  [-79.5278085632552, -5.107187748073887],
                  [-79.52787293627156, -5.1038108868460865],
                  [-79.53345193102254, -5.10385363203603],
                  [-79.53334464266194, -5.106482455742338]]]),
            {
              "id": 21,
              "system:index": "1"
            })]),
    agua = 
    /* color: #1171d5 */
    /* shown: false */
    ee.Geometry.MultiPoint(
        [[-77.83131232953383, -8.576597981529815],
         [-77.91470309709617, -8.623401073448127],
         [-77.99301882006188, -8.679377315476115],
         [-78.02913936560091, -8.64133867185188],
         [-78.18886010012032, -8.632006412652903],
         [-77.13979425191854, -10.336249206730514],
         [-77.15284051656698, -10.335995893216655],
         [-77.14541616201376, -10.330507383601995],
         [-77.11897958910129, -10.3340115969585],
         [-77.08084828349325, -10.412532382037453],
         [-77.11330328341796, -10.465523599818217],
         [-76.86162331489734, -11.753819891051382],
         [-76.8996100559162, -11.85593310093699],
         [-76.51582203820605, -12.0670378863195],
         [-76.5125175566997, -12.070563097226872],
         [-76.52530632928271, -12.061204399762216],
         [-76.13216868170657, -12.879969309449937],
         [-76.14401331671634, -12.871769405721109],
         [-75.8156066528896, -13.40348644840101],
         [-75.80341869512593, -13.408662947065135],
         [-75.76729660296847, -13.384970942804932]]),
    geometry_3 = 
    /* color: #ffc82d */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-74.9082697257806, -14.47642568391849],
                  [-74.9108446464349, -14.480497821623144],
                  [-74.91058715436947, -14.483863511676097],
                  [-74.90578063581478, -14.485359357529404],
                  [-74.90599521253597, -14.480248509217521],
                  [-74.90530856702816, -14.477630712044753],
                  [-74.90603812788021, -14.47609326121491],
                  [-74.90573772047054, -14.474638906032295],
                  [-74.90792640302669, -14.474929777831239],
                  [-74.90848430250179, -14.4759686025727]]]),
            {
              "id": 3,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-74.91658940970748, -14.478918838322766],
                  [-74.91440072715133, -14.476675000619418],
                  [-74.91487279593795, -14.475594626225924],
                  [-74.91547361075729, -14.473766288348346],
                  [-74.91650357901901, -14.474057161290853],
                  [-74.91950765311569, -14.476716553375658],
                  [-74.9225546425566, -14.479957644390211],
                  [-74.92225423514694, -14.482243000617604]]]),
            {
              "id": 3,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-74.91980806052536, -14.47239502505681],
                  [-74.91882100760787, -14.471480844823162],
                  [-74.9187351769194, -14.470608214724772],
                  [-74.91912141501754, -14.469278486074845],
                  [-74.91980806052536, -14.467450096178469],
                  [-74.92088094413131, -14.466660559523767],
                  [-74.92341294944137, -14.467616314063875],
                  [-74.92414251029342, -14.468946052668048],
                  [-74.92315545737594, -14.4702757833089],
                  [-74.92246881186813, -14.47301832760309]]]),
            {
              "id": 3,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-74.91737097504789, -14.46547452438222],
                  [-74.91642683747465, -14.468466453900591],
                  [-74.91488188508207, -14.468217127980358],
                  [-74.910547435314, -14.467053603317806],
                  [-74.90981787446195, -14.466139401091981],
                  [-74.90990370515043, -14.465266750002236],
                  [-74.91325110200101, -14.462150110979268],
                  [-74.91698473694974, -14.464684980704215]]]),
            {
              "id": 3,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-74.93181045807604, -14.467612177253065],
                  [-74.92644604004626, -14.462376254005582],
                  [-74.92404278076891, -14.460049137390808],
                  [-74.92506827878711, -14.458318069028984],
                  [-74.92549743222949, -14.454411752347147],
                  [-74.9282010989165, -14.452333896353517],
                  [-74.9296602206206, -14.453248155383566],
                  [-74.93051852750537, -14.456489588916964],
                  [-74.93141974973437, -14.459481639448573],
                  [-74.93320144750606, -14.462121116813282],
                  [-74.93457473852169, -14.464655986869099],
                  [-74.9332443628503, -14.466276626334851]]]),
            {
              "id": 3,
              "system:index": "4"
            })]),
    imageVisParam = {"opacity":1,"bands":["slope"],"min":0,"max":8.355083465576172,"palette":["ffffcc","fffcc3","fef9ba","fdf5af","fdf1a6","fcee9d","fbea94","fae58b","f8df80","f7d977","f6d36f","f4cc68","f2c562","f1bd5c","efb759","eeb057","ecaa55","eba454","ea9d53","e89752","e79152","e68c51","e48651","e27e50","df7850","dd724f","d96b4e","d3634d","cd5d4c","c5574a","bd5248","b54d46","aa4944","a14641","98433e","8f403b","863e37","7b3a33","73382f","6a352b","613227","593023","4f2c1e","472a1a","3f2717","372513","302210","271f0b","201c06","1a1a01"]};
/***** End of imports. If edited, may not auto-convert in the playground. *****/


/** 
 * STEP 04-0: CLASIFICACION
 * ----------------------------------------------------------------------------------------------
 */ 

var param = {
  country: 'PERU',
  regionId: 70401,
  trees: 60,
  variables: [
  "blue_median",
  "green_dry",
  "green_median",
  "green_min",
  "red_dry",
  "red_median",
  "red_min",
  "red_wet",
  "nir_dry",
  "nir_median",
  "nir_min",
  "nir_stdDev",
  "nir_wet",
  "swir1_dry",
  "swir1_median",
  "swir1_min",
  "swir1_wet",
  "swir2_dry",
  "swir2_median",
  "swir2_min",
  "swir2_wet",
  "ndfi_amp",
  "ndfi_dry",
  "ndfi_median",
  "ndfi_stdDev",
  "ndfi_wet",
  "ndfib_amp",
  "ndfib_median",
  "gv_amp",
  "gv_median",
  "gv_stdDev",
  "gvs_dry",
  "gvs_median",
  "gvs_stdDev",
  "gvs_wet",
  "npv_median",
  "npv_stdDev",
  "shade_median",
  "snow_median",
  "snow_min",
  "soil_amp",
  "soil_median",
  "soil_stdDev",
  "fns_dry",
  "fns_stdDev",
  "gcvi_dry",
  "gcvi_median",
  "gcvi_wet",
  "pri_dry",
  "pri_median",
  "evi2_amp",
  "evi2_dry",
  "evi2_median",
  "evi2_stdDev",
  "evi2_wet",
  "ndvi_amp",
  "ndvi_dry",
  "ndvi_median",
  "ndvi_stdDev",
  "ndvi_wet",
  // "ndsi_median",
  "ndsi_min",
  "ndwi_gao_amp",
  "ndwi_gao_dry",
  // "ndwi_gao_median",
  "ndwi_gao_wet",
  "ndwi_mcfeeters_amp",
  "ndwi_mcfeeters_median",
  "savi_dry",
  "savi_median",
  "savi_stdDev",
  "savi_wet",
  "sefi_dry",
  "sefi_median",
  "sefi_stdDev",
  "wefi_amp",
  "wefi_stdDev",
  "wefi_wet",
  // "nuaci_median",
  "hallcover_median",
  "textG_median",
  "cai_max",
  "cai_median",
  "cai_min",
  "gli_dry",
  "gli_max",
  "gli_median",
  "gli_min",
  "mndwi_dry",
  "mndwi_max",
  "mndwi_median",
  "mndwi_wet",
  "ndbi_dry",
  "ndbi_max",
  "ndbi_median",
  "ndbi_min",
  "ndgb_dry",
  "ndgb_max",
  "ndgb_median",
  "ndgb_stdDev",
  "ndgb_wet",
  "ndmi_dry",
  // "ndmi_max",
  // "ndmi_median",
  // "ndmir_max",
  // "ndmir_median",
  // "ndmir_min",
  // "ndmir_stdDev",
  // "ndmir_wet",
  "ndrb_min",
  "ndrb_stdDev",
  "ndrb_wet",
  "ndsi2_dry",
  // "ndsi2_median",
  "ndsi2_max",
  "ndsi2_min",
  "ndsi2_wet",
  "cloud_median",
  "cai_wet_min",
  "green_dry_qmo",
  "green_wet_min",
  "green_wet_qmo",
  "ndwi_gao_dry_min",
  "ndwi_gao_wet_max",
  "ndwi_gao_wet_min",
  "ndwi_gao_wet_qmo",
  "nir_dry_qmo",
  "nir_wet_qmo",
  "red_dry_max",
  "red_dry_min",
  "red_dry_qmo",
  "red_wet_max",
  "swir1_dry_max",
  "swir1_dry_qmo",
  "swir1_wet_max",
  "swir1_wet_min",
  "swir1_wet_qmo",
  "swir2_dry_min",
  "swir2_dry_qmo",
  "swir2_wet_max",
  "swir2_wet_qmo",
  "altitude",
  "slope",
  "longitude",
  "latitude",
  "hand30_100",
  "hand30_1000",
  "hand30_5000",
  "hand90_1000",
  "water_HAND_0m",
  "water_HAND_1m",
  "water_HAND_2m",
  "water_HAND_5m",
  "water_HAND_10m",
  "slppost",
  "shademask2"
  ],
  tileScale: 4,
  additionalSamples: {

    polygons: [geometry_11, geometry_13],
    classes: [ 11, 13],
    points: [500,700],
    lastCollPoints : 10
  },
  yearsProcess: [
    1985, 1986, 1987, 1988, 1989, 1990, 1991, 1992, 1993, 1994, 1995,
    1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 
    2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017,
    2018, 2019, 2020, 2021, 2022, 2023, 2024
    ],
  yearsPreview: [1986, 1990, 2000, 2010, 2017, 2018, 2023, 2024], //
  driveFolder: 'RF-PRELIMINAR-CLASSIFICATION',
  samplesVersion: 1,
  outputVersion: 1,
  exports : {
    importance_variable: false,
    classification_drive: false
     },
  useRegionBuffer: false,   // si se pone true se va a generar un buffer de 250m en la region de clasificacion
  maskNoDataValue: false,  //Mask the no data values
  ExportArea:{ // habilita la opcin de exporta el rea de la clasificacin preliminar. 
    Export:true,
    Unit:1e4,
    folder:'MB-C3-Area',
  },
  LastColGeom:{ 
    CompGeometry:true, //si existe geometrias complementarias para esa region de la coleccion pasad
  },
  canopy_height:{ //condicional de reclasificacion usando canopy height 
      useCanopy_height: false,
      canopy_height_thr_lower: 1,  // valor minimo del rango del canopy height
      canopy_height_thr_upper: 8,  // valor maximo del rango del canopy height 
      class_origin: 12, //classe con la que se trabajara el condicional
      class_reclass: 4 //clase a la que se reclasificar
  },
    slopefilter:{ //condicional de reclasificacion usando un valor minimo de pendiente (slope)
    useSlope_filter: false,
    slope_thr: 10, //si la pendiente es mayor a 10 se remapea
    class_origin : 33, 
    class_remap:25 //clase que cambiara los pixeles de agua en zonas de zombra
  },
    
  slopeWetlandFilter:{ //condicional de reclasificacin para dos clases usndo dos valores referencial de pendiente 
    useSlope_filter: false,
    wetSlope_thr: 17,// por debajo de este valor, la clase 3 se reclasifica a 11
    forestSlope_thr:20//por encima de este valor, la clase 11 se reclasifica a 3
  },
  
  AltitudeFilter:{
    UseAltitude: false,
    Altitude_thr: 2100,
    class_origin : 4, 
    class_reclass: 12
  },
  
  AspectFilter:{
    UseAspect: false,
    AspectLower:28,
    AspectUpper:98,
    class_origin:4,
    class_reclass:12
  }
};


print(param.additionalSamples.classes, 'param.classes.type')
/**
 * Import Modules CollectionDirectories
 */
var dirs = require('users/mapbiomasperu/mapbiomas-lulc:collection-3/modules/CollectionDirectories-cloud.js');
var paths = dirs.listpaths(param.country);
var canopy_height = 'users/nlang/ETH_GlobalCanopyHeight_2020_10m_v1'
var canopy_height = ee.Image(canopy_height);
/**
 * Import Collection 2 additional samples
 */
//col2 geometries 1985 - 2022

if(param.LastColGeom.CompGeometry){
  var fileName = 'polygons-1985-2022-' + param.regionId + '-PERU-1';
  var basePath = 'projects/mapbiomas-peru/assets/LAND-COVER/COLLECTION2/SAMPLES/GEOMETRIAS_COMPLEMENTARIAS/';
  var stableGeometriesLastColl = ee.FeatureCollection(basePath + fileName)
  print('lastcoll',stableGeometriesLastColl.limit(10))
}


/**
 * Get region vector and mask
 */
var region = ee.FeatureCollection(paths.regionVector);
region = region.filterMetadata("id_regionC", "equals", param.regionId);

if(param.useRegionBuffer){
  region = region.map(function(fea){return fea.buffer(250)})
}

var regionMask = region
  .map(function(item) {
    return item.set('version', 1);
  })
  .reduceToImage(['version'], ee.Reducer.first());
  


var geom = ee.FeatureCollection(
    region.geometry().bounds()
  )
  .map(function(item) {
    return item.set('version', 1);
  })
  .reduceToImage(['version'], ee.Reducer.first());
 
  

/**
 * Input data
 */
// Parameters
var country = param.country;
var regionId = param.regionId;
var variables = param.variables;
var nBands = variables.length;
var outputVersion = param.outputVersion;
var trees = param.trees;
var additionalSamples = param.additionalSamples;
var yearsPreview = param.yearsPreview;
var driveFolder = param.driveFolder;
var samplesVersion = param.samplesVersion;


// Paths
var basePath = paths.classification;
var samplesPath = paths.trainingPoints01
var trainingSamples = samplesPath + 'samples-' + country + '-' + regionId;
 
// Imports
var palette = require('users/mapbiomas/modules:Palettes.js').get('classification8');
var GenaPalettes = require('users/gena/packages:palettes');

// Constants
var years = param.yearsProcess


// Outputs initialization
var variablesImportance = ee.FeatureCollection([]);
var classified = ee.Image(0);



/**
 * Set up mosaics
 */
var mosaicRegion = param.regionId.toString().slice(0, 3);
var joinedMosaics;

/* 
if(param.country === 'PERU') {
  
  joinedMosaics = ee.ImageCollection('projects/mapbiomas-raisg/MOSAICOS/workspace-c3-v2')
    .filterMetadata('region_code', 'equals', mosaicRegion);
    
}

else {
*/  
  joinedMosaics = ee.ImageCollection(paths.mosaics_c4_raisg).merge(ee.ImageCollection(paths.mosaics_c4_nexgen))//c3_v2
    .filterMetadata('region_code', 'equals', Number(mosaicRegion));
    
//}
print(joinedMosaics.first().bandNames())


var unmaskMosaic = function(image) {
    var blue = image.select('blue_median').rename(['constant']);
    var bluemask = blue.updateMask(blue.eq(0));
    var bands = image.bandNames();
    
    return ee.ImageCollection(
        bands
        .map(function(band) {
          var imgBand = image.select([band]).rename(['constant']);
          return bluemask.blend(imgBand).rename([band]); //.unmask(0);
        })
      )
      .toBands()
      .rename(bands);

  };


/**
 * Function for taking additional samples
 */
var resampleCover = function(mosaic, additionalSamples) {
  
  var polygons = additionalSamples.polygons,
      classIds = additionalSamples.classes,
      points = additionalSamples.points,
      newSamples = [];
  
  polygons.forEach(function(polygon, i) {
    
    var newSample = mosaic.sample({
      numPixels: points[ i ],
      region: polygon,
      scale: 30,
      projection: 'EPSG:4326',
      seed: 1,
      geometries: true,
      tileScale:param.tileScale
    })
    .map(function(item) { return item.set('reference', classIds[ i ]) });
    
    newSamples.push(newSample);

  });
  
  return ee.FeatureCollection(newSamples).flatten();

};


/**
 * Function for taking additional samples
 */
var resampleCover_lastColl = function(mosaic, additionalSamples, npoint) {
  
  var polygons = additionalSamples.polygons,
      classIds = additionalSamples.classes,
      points = additionalSamples.points,
      newSamples = [];
  
  polygons.forEach(function(polygon, i) {
    
    var newSample = mosaic.sample({
      numPixels: points[ i ],
      region: polygon,
      scale: 30,
      projection: 'EPSG:4326',
      seed: 1,
      geometries: true,
      tileScale:param.tileScale
    })
    .map(function(item) { return item.set('reference', classIds[ i ]) });
    
    newSamples.push(newSample);

  });
  
  return ee.FeatureCollection(newSamples).flatten();

};

 
 // Importar datos de altitud
  var altitude = ee.Image('JAXA/ALOS/AW3D30_V1_1')
    .select('AVE')
    .rename('altitude');
      
  var slope = ee.Terrain.slope(altitude).int8()
    .rename('slope');
    
  /**
   * Hand
   */
  //-----------------------------------------------------------------------------
    var hand30_100 = ee.ImageCollection('users/gena/global-hand/hand-100');
    var srtm = ee.Image("USGS/SRTMGL1_003");
    var hand30_1000 =  ee.Image("users/gena/GlobalHAND/30m/hand-1000");
    var hand90_1000 = ee.Image("users/gena/GlobalHAND/90m-global/hand-1000");
    var hand30_5000 = ee.Image("users/gena/GlobalHAND/30m/hand-5000");
    var fa = ee.Image("users/gena/GlobalHAND/90m-global/fa");
    var jrc = ee.Image("JRC/GSW1_0/GlobalSurfaceWater");
    var HS_fa = ee.Image("WWF/HydroSHEDS/15ACC");
    var HS_fa30 = ee.Image("WWF/HydroSHEDS/30ACC");
    var demUk = ee.Image("users/gena/HAND/test_uk_DSM");
    
    // smoothen HAND a bit, scale varies a little in the tiles
    hand30_100 = hand30_100.mosaic().focal_mean(0.1);
    
    // potential water (valleys)
    var thresholds = [0,1,2,5,10];
    var HANDm = ee.List([]);
    thresholds.map(function(th) {
      var water = hand30_100.lte(th)
        .focal_max(1)
        .focal_mode(2, 'circle', 'pixels', 5).mask(swbdMask);
        
      HANDm = HANDm.add(water.mask(water).set('hand', 'water_HAND_<_' + th + 'm'));
    });
    
    // exclude SWBD water
    var swbd = ee.Image('MODIS/MOD44W/MOD44W_005_2000_02_24').select('water_mask');
    Map.addLayer(swbd, {}, 'swbd mask', false);
    var swbdMask = swbd.unmask().not().focal_median(1);
    
    // water_hand	water (HAND < 5m)
    var HAND_water = ee.ImageCollection(HANDm)
    
    // exports.
    hand30_100  =hand30_100.rename('hand30_100');
    hand30_1000 =hand30_1000.rename('hand30_1000');
    hand30_5000 =hand30_5000.rename('hand30_5000');
    hand90_1000 =hand90_1000.rename('hand90_1000');
    HAND_water  =HAND_water.toBands().rename(['water_HAND_0m',
                                                  'water_HAND_1m',
                                                  'water_HAND_2m',
                                                  'water_HAND_5m',
                                                  'water_HAND_10m']);
            
    var Hand_bands =  hand30_100.addBands(hand30_1000)
                                .addBands(hand30_5000)
                                .addBands(hand90_1000)
                                .addBands(HAND_water);
                                
    // print(Hand_bands)
  
  /**
   * Latitud Longitud
   */
  //-----------------------------------------------------------------------------
  var longLat = ee.Image.pixelLonLat();
  
  /**
   * ShadeMask2
   */
  //-----------------------------------------------------------------------------
  var shademask2 = ee.Image("projects/mapbiomas-raisg/MOSAICOS/shademask2_v3").rename('shademask2');
  
  /**
   * slppost
   */
  //-----------------------------------------------------------------------------
  var slppost = ee.Image("projects/mapbiomas-raisg/MOSAICOS/slppost2_30_v3").rename('slppost');
  
  //-----------------------------------------------------------------------------
      /** 
   * Slope FABDEM for filtering  
   * 
   */
   
  var FABDEM = ee.ImageCollection("projects/sat-io/open-datasets/FABDEM");
  var proj_FABDEM = FABDEM.first().select(0).projection();//.aside(print);
  var slopeFABDEM = ee.Terrain.slope(FABDEM.mosaic()
                               .setDefaultProjection(proj_FABDEM))
                               .rename('slope')
                               
  var paletteFABDEM = GenaPalettes.crameri.lajolla[50] 
  Map.addLayer(slopeFABDEM, {palette: paletteFABDEM}, 'slopeFABDEM', false)                             
  print(slopeFABDEM, 'slopeFABDEM')
 
       /** 
   * Altitude FABDEM for filtering  
   * 
   */
   
  var AltFabdem = FABDEM.mosaic().setDefaultProjection(proj_FABDEM)
  Map.addLayer(AltFabdem, {palette: paletteFABDEM}, 'AltitudeFABDEM', false)
  print(AltFabdem, 'AltitudeFABDEM')
  
         /** 
   * Aspect FABDEM for filtering  
   * 
   */
   
  var aspect = ee.Terrain.aspect(AltFabdem);
  var AspViz = { min: 0, max: 360, palette: ['00FFFF', '0000FF', 'FF00FF', 'FFFF00', 'FF0000', '00FF00'] };
  Map.addLayer(aspect, AspViz, 'Aspect', false);
  print(aspect, 'AspectFABDEM')
  

 
/**
 * Implement random forests classification
 */
ee.List(years).evaluate(function(years, error){
  
  if(error) print(error.message);
  
  var variablesImportance = ee.FeatureCollection([]);

  years.forEach(function(year) {
  

  
    var yearMosaic = joinedMosaics
      .filterMetadata('year', 'equals', year)
      .median();
      
    if(param.maskNoDataValue){
      yearMosaic = unmaskMosaic(yearMosaic);
     }
     
    yearMosaic = yearMosaic
                  .addBands(altitude)
                  .addBands(slope)
                  .addBands(longLat)
                  .addBands(Hand_bands)
                  .addBands(slppost)
                  .addBands(shademask2)
                  .updateMask(regionMask);
      
    var yearMosaicRGB = yearMosaic;
    
    if(variables.length > 0) yearMosaic = yearMosaic.select(variables);
      
    var bands = yearMosaic.bandNames();
    
    var contained = bands.containsAll(ee.List(variables));
    

    var yearTrainingSamples = ee.FeatureCollection(
      ee.Algorithms.If(
        contained,
        ee.FeatureCollection(
          trainingSamples + '-' + year + '-' + 'p03-' + samplesVersion),
        null
      )
    );

    
    var nClasSample = ee.List(
      ee.Algorithms.If(
        contained,
        yearTrainingSamples
          .reduceColumns(ee.Reducer.toList(), ['reference'])
          .get('list'),
        null
      )
    );

    
    // Identify number of classes in th samples.
    nClasSample = nClasSample.reduce(ee.Reducer.countDistinct());
    
    
    // Here we put additional samples
    if(additionalSamples.polygons.length > 0){
      
      var insidePolygons = ee.FeatureCollection(additionalSamples.polygons)
        .flatten()
        .reduceToImage(['id'], ee.Reducer.first());
      
      var outsidePolygons = insidePolygons.mask().eq(0).selfMask();
      outsidePolygons = geom.updateMask(outsidePolygons);

      
      var outsideVector = outsidePolygons.reduceToVectors({
        reducer: ee.Reducer.countEvery(),
        geometry: region.geometry().bounds(),
        scale: 30,
        maxPixels: 1e13
      });

      
      var newSamples = resampleCover(yearMosaic, additionalSamples);
      
      
      yearTrainingSamples = yearTrainingSamples.filterBounds(outsideVector)
        .merge(newSamples);
    }
    
    // Add Last coll geometries 
    if(year < 2023 && param.LastColGeom.CompGeometry){
            
      var insidePolygons2 = ee.FeatureCollection(stableGeometriesLastColl)
                             .reduceToImage(['id'], ee.Reducer.first());
      
      var outsidePolygons2 = insidePolygons2.mask().eq(0).selfMask();
      outsidePolygons2 = geom.updateMask(outsidePolygons2);

      
      var outsideVector2 = outsidePolygons2.reduceToVectors({
        reducer: ee.Reducer.countEvery(),
        geometry: region.geometry().bounds(),
        scale: 30,
        maxPixels: 1e13
      });

      var point_last_coll =insidePolygons2.rename('reference').stratifiedSample({
          numPoints: param.additionalSamples.lastCollPoints,
          classBand: 'reference',
          region: stableGeometriesLastColl,
          scale: 30,
          seed: 1,
          geometries: true,
          dropNulls: true,
          tileScale: param.tileScale
      });
      
      var training = insidePolygons2
        .addBands(yearMosaic)
        .sampleRegions({
          collection: point_last_coll,
          properties: ['reference'],
          scale: 30,
          geometries: true,
          tileScale: param.tileScale
        });

      yearTrainingSamples = yearTrainingSamples.filterBounds(outsideVector)
                                               .merge(training);
    }
    
    
    // Define classifier and compute importance tables
    var classifier = ee.Classifier.smileRandomForest({
        numberOfTrees: trees, 
        variablesPerSplit: 1
    });
    

    classifier = ee.Classifier(
      ee.Algorithms.If(
        contained,
        ee.Algorithms.If(
          // solucin al problema 'only one class'
          ee.Algorithms.IsEqual(nClasSample, 1),
          null,
          classifier.train(yearTrainingSamples, 'reference', bands)
        ),
        null
      )
    );
    
    
    var explainer = ee.Dictionary(
      ee.Algorithms.If(
        contained,
        ee.Algorithms.If(
          ee.Algorithms.IsEqual(nClasSample, 1) ,
          null,
          classifier.explain()
        ),
        null
      )
    );
    
    
    //Importance table
    var importances = ee.Feature(
      ee.Algorithms.If(
        contained,
        ee.Algorithms.If(
          // solucin al problema 'only one class'
          ee.Algorithms.IsEqual(nClasSample, 1),
          null,
          ee.Feature( null, 
            ee.Dictionary(explainer.get('importance')))
              .set('_trees', explainer.get('numberOfTrees'))
              .set('_oobError', explainer.get('outOfBagErrorEstimate'))
              .set('_year', year)
        ),
        null
      )
    );
    
    variablesImportance = variablesImportance
        .merge( ee.FeatureCollection( [ importances ] ));
    
    
    
    // Compute classification
    var img = yearMosaic.classify(classifier)
      .select(['classification'], ['classification_' + year]);
    
    if(param.canopy_height.useCanopy_height){
      // Canopy height forest
      var canopy_height_forest = canopy_height.gte(param.canopy_height.canopy_height_thr_lower).and(canopy_height
                                              .lte(param.canopy_height.canopy_height_thr_upper));
    
      img = img.where(img.eq(param.canopy_height.class_origin).and(canopy_height_forest.eq(1)), param.canopy_height.class_reclass)
               //.where(img.neq(4).and(canopy_height_forest.eq(1)), 4)
               //.where(img.neq(6).and(canopy_height_forest.eq(1)), 6).selfMask()
      }
    //Slope Water Filter
    if(param.slopefilter.useSlope_filter){
      var steepSlopes = slopeFABDEM.gte(param.slopefilter.slope_thr);
      
      img = img.where(img.eq(param.slopefilter.class_origin).and(steepSlopes.eq(1)), param.slopefilter.class_remap).selfMask()
    }
    
    //Slope Wetland Filter
    if(param.slopeWetlandFilter.useSlope_filter){
      var WetlandSlopes = slopeFABDEM.lte(param.slopeWetlandFilter.wetSlope_thr);
      
      var ForestSlope = slopeFABDEM.gte(param.slopeWetlandFilter.wetSlope_thr)
      
      img = img.where(img.eq(3).and(WetlandSlopes.eq(1)), 11)
                .where(img.eq(11).and(ForestSlope).eq(1), 3).selfMask()
    }   
    var maskBand = ee.Image(27).rename('classification_' + year);
    
    //Altitude Filter
    
    if(param.AltitudeFilter.UseAltitude){
      var altitudeCond = AltFabdem.gte(param.AltitudeFilter.Altitude_thr);
      
      img = img.where(img.eq(param.AltitudeFilter.class_origin)
                .and(altitudeCond.eq(1)), param.AltitudeFilter.class_reclass)
                .selfMask()
    }
    
    //Aspect Filter
  
    
    if(param.AspectFilter.UseAspect){
      var aspectCond = aspect.gte(param.AspectFilter.AspectLower)
                              .and(aspect.lte(param.AspectFilter.AspectUpper));

      img = img.where(img.eq(param.AspectFilter.class_origin).and(aspectCond.eq(1)), param.AspectFilter.class_reclass)
    }

    classified = ee.Image(
      ee.Algorithms.If(
        contained,
        ee.Algorithms.If(
          // Solution to problem of 'only one class'
          ee.Algorithms.IsEqual(nClasSample, 1),
          classified.addBands(maskBand),
          classified.addBands(img)
        ),
        classified.addBands(maskBand)
      )
    ).unmask(27).updateMask(regionMask).toByte();
    
    
    // display mosaic and classification
    if(yearsPreview.indexOf(year) > -1) {
      Map.addLayer(
        yearMosaicRGB,
        {
          bands: ['swir1_median', 'nir_median', 'red_median'],
          gain: [0.08, 0.06, 0.2]
        },
        'MOSAICO ' + year.toString(), false
      );
      
      Map.addLayer(
        img.select('classification_' + year)
           .unmask(27).updateMask(regionMask),
        {
          min: 0,
          max: 62,
          palette: palette
        },
        'CLASIFICACIN ' + year, false
      );
    }
    
    return classified;

  });
  

  if(param.canopy_height.useCanopy_height){
    Map.addLayer(canopy_height.updateMask(regionMask),{"min":1,"max":35,
                               "palette":["ff0000","ff9e0f","fcff0c","4fff13","08cc16"]}, 'canopy_height', false
                               )
  }
  
  classified = classified.slice(1).toInt8()
    .set({
      code_region: regionId,
      pais: country,
      version: outputVersion,
      RFtrees: trees,
      samples_version: samplesVersion,
      descripcion: 'clasificacion-v1',
      paso: 'P04-0'
    });
    
  print('Para Exportar: ',classified)

  // Exportar assets a GEE y Google Drive
  var filename = country + '-' + regionId + '-' + outputVersion;
  var imageId = basePath + '/' + filename;  
  var tableName = 'IMPORTANCE-TABLE-' + country + '-';
  tableName = tableName + regionId + '-' + outputVersion;
  
  Export.image.toAsset({
    image: classified,
    description: filename,
    assetId: imageId,
    scale: 30,
    pyramidingPolicy: {
      '.default': 'mode'
    },
    maxPixels: 1e13,
    region: region.geometry().bounds()
  });
  
if(param.exports.classification_drive){
  Export.image.toDrive({
    image: classified,
    description: filename + '-DRIVE',
    folder: driveFolder,
    scale: 30,
    maxPixels: 1e13,
    region: region.geometry().bounds()
  });
  }
if(param.exports.importance_variable){
  Export.table.toDrive({
    collection: variablesImportance, 
    description: tableName,
    folder: driveFolder,
    fileFormat: 'CSV',
  });
}

//**********************************************
// Funcin para generar las estadsticas de cobertura por ao y clase
//**********************************************
var pixelArea = ee.Image.pixelArea().divide(param.ExportArea.Unit);
var YearStat=1985;
var convert2featCollection = function (item) {

    item = ee.Dictionary(item);

    var feature = ee.Feature(null)
        .set('Clase_id', item.get('classe'))
        .set("area", item.get('sum'))
        .set("year", YearStat)
        .set("region", param.regionId)
        .set("country",param.country)
    return feature;

};
var calculateArea = function (image, geometry) {

    var reducer = ee.Reducer.sum().group(1, 'classe').group(1, 'featureid');
    var reg = image.reduce('max').gt(0);
    reg = reg.mask(reg.gt(0))
    var pixelAreaTemp = pixelArea.clip(geometry);
    image = image.clip(geometry).selfMask()
    
    var res= ee.FeatureCollection([])
    var imgTemp;
    var areas;
    imgTemp = image
    //areas = pixelAreaTemp.addBands(reg).addBands(imgTemp)
    areas = pixelAreaTemp.addBands(reg).addBands(imgTemp)
          .reduceRegion({
              reducer: reducer,
              geometry: geometry.geometry().bounds(),
              scale: 30,
              maxPixels: 1e12
          });
  
      areas = ee.FeatureCollection(
          ee.List(ee.Dictionary(ee.List(areas.get('groups')).get(0)).get('groups'))
          .map(convert2featCollection)
      );
      res = res.merge(areas)
    return res;
};

  if (param.ExportArea.Export){
    var resArea = ee.FeatureCollection([])
    var tab,nomb;
    param.yearsProcess.forEach(function(y){
      YearStat = y
      tab = calculateArea(classified.select('classification_'+y), region)
      resArea = resArea.merge(tab)
    })
    //exportamos el resultado de las superficies 
    nomb = 'Sup-'+param.country+'-'+param.regionId+'-'+param.outputVersion
    Export.table.toDrive({
      collection:resArea, 
      description:nomb, 
      folder:param.ExportArea.folder, 
      fileNamePrefix:nomb, 
      fileFormat:'CSV', 
    })
  }

});

  // geometries
  var GeometriesIE = ee.FeatureCollection(param.additionalSamples.polygons).flatten()
  print(GeometriesIE.size()) 
  
  // year stable data
  var year_t0 = param.yearsProcess[0]
  var year_t1 = param.yearsProcess[param.yearsProcess.length - 1]
  
  // export to asset
  var fileName = 'polygons' + '-' +year_t0 + '-' + year_t1 + '-' + param.regionId + '-' + param.country  + '-' + param.outputVersion;
  var assetIdG = 'projects/mapbiomas-peru/assets/LAND-COVER/COLLECTION2/SAMPLES/GEOMETRIAS_COMPLEMENTARIAS/' + fileName;
  Export.table.toAsset(GeometriesIE, fileName, assetIdG);
  

